{% extends "core/base.html" %}

{% block title %}Dashboard - My Profile{% endblock %}

{% block content %}
<div class="container-fluid py-5">
    <div class="row g-4">

        <!-- ================== Profile Sidebar ================== -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 text-center p-4">
                {% if request.user.profile_image %}
                    <img src="{{ request.user.profile_image.url }}" class="rounded-circle mb-3" width="140" height="140">
                {% else %}
                    <img src="https://via.placeholder.com/140" class="rounded-circle mb-3">
                {% endif %}
                <h4>{{ request.user.get_full_name|default:request.user.username }}</h4>
                <p class="text-muted">{{ request.user.email }}</p>
                <span class="badge bg-success mb-2">{{ request.user.is_active|yesno:"Active,Inactive" }}</span>
                <p class="text-muted small">Joined: {{ request.user.date_joined|date:"M d, Y" }}</p>

                <hr>
                <ul class="nav nav-pills flex-column" id="profileTabs" role="tablist">
                    <li class="nav-item mb-2" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
                    </li>
                    <li class="nav-item mb-2" role="presentation">
                        <button class="nav-link" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab">Edit Profile</button>
                    </li>
                    <li class="nav-item mb-2" role="presentation">
                        <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">Activity</button>
                    </li>
                    <li class="nav-item mb-2" role="presentation">
                        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">Analytics</button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- ================== Main Content ================== -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 p-4">
                <div class="tab-content" id="profileTabsContent">

                    <!-- ===== Overview ===== -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <h5 class="mb-4">Profile Overview</h5>
                        <table class="table table-borderless">
                            <tr>
                                <th>Full Name:</th>
                                <td>{{ request.user.get_full_name|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Username:</th>
                                <td>{{ request.user.username }}</td>
                            </tr>
                            <tr>
                                <th>Email:</th>
                                <td>{{ request.user.email }}</td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td><span class="badge bg-success">{{ request.user.is_active|yesno:"Active,Inactive" }}</span></td>
                            </tr>
                            <tr>
                                <th>Joined:</th>
                                <td>{{ request.user.date_joined|date:"M d, Y" }}</td>
                            </tr>
                        </table>
                    </div>

                    <!-- ===== Edit Profile ===== -->
                    <div class="tab-pane fade" id="edit" role="tabpanel">
                        <h5 class="mb-4">Edit Your Profile</h5>
                        <form id="editProfileForm" method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3 text-center">
                                {% if request.user.profile_image %}
                                    <img src="{{ request.user.profile_image.url }}" class="rounded-circle mb-2" width="120" height="120">
                                {% else %}
                                    <img src="https://via.placeholder.com/120" class="rounded-circle mb-2">
                                {% endif %}
                                <input type="file" name="profile_image" class="form-control mt-2">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Full Name</label>
                                <input type="text" name="full_name" class="form-control" value="{{ request.user.get_full_name }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" name="username" class="form-control" value="{{ request.user.username }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" name="email" class="form-control" value="{{ request.user.email }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">New Password</label>
                                <input type="password" name="password" class="form-control" placeholder="Leave blank to keep current">
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Update Profile</button>
                            </div>
                        </form>
                        <div id="editProfileMessage" class="mt-3"></div>
                    </div>

                    <!-- ===== Activity ===== -->
                    <div class="tab-pane fade" id="activity" role="tabpanel">
                        <h5 class="mb-4">Recent Activity</h5>
                        <ul class="list-group" id="activityList">
                            {% for article in recent_articles %}
                                <li class="list-group-item">
                                    Published: <strong>{{ article.title }}</strong> on {{ article.created_at|date:"M d, Y" }}
                                </li>
                            {% endfor %}
                            {% for comment in recent_comments %}
                                <li class="list-group-item">
                                    Commented on "<strong>{{ comment.article.title }}</strong>": {{ comment.body|truncatechars:50 }}
                                </li>
                            {% endfor %}
                            {% for login in recent_logins %}
                                <li class="list-group-item">
                                    Logged in at {{ login.timestamp|date:"M d, Y H:i" }} from IP {{ login.ip }}
                                </li>
                            {% endfor %}
                            {% if not recent_articles and not recent_comments and not recent_logins %}
                                <li class="list-group-item text-center text-muted">No recent activity.</li>
                            {% endif %}
                        </ul>
                    </div>

                    <!-- ===== Analytics ===== -->
                    <div class="tab-pane fade" id="analytics" role="tabpanel">
                        <h5 class="mb-4">Analytics</h5>
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <canvas id="articlesChart"></canvas>
                            </div>
                            <div class="col-md-6 mb-4">
                                <canvas id="commentsChart"></canvas>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== Chart.js ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function renderCharts(articleLabels, articleData, commentLabels, commentData) {
    const articlesChart = new Chart(document.getElementById('articlesChart'), {
        type: 'line',
        data: {
            labels: articleLabels,
            datasets: [{
                label: 'Articles',
                data: articleData,
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: { responsive: true, plugins: { legend: { display: true } } }
    });

    const commentsChart = new Chart(document.getElementById('commentsChart'), {
        type: 'line',
        data: {
            labels: commentLabels,
            datasets: [{
                label: 'Comments',
                data: commentData,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: { responsive: true, plugins: { legend: { display: true } } }
    });
}

// Initial render using template data
renderCharts({{ article_labels|safe }}, {{ article_data|safe }}, {{ comment_labels|safe }}, {{ comment_data|safe }});

// Optional: AJAX for live update (requires a view returning JSON)
document.getElementById('profileTabs').addEventListener('shown.bs.tab', function (event) {
    if(event.target.id === 'analytics-tab') {
        fetch("{% url 'accounts:profile_analytics_data' %}")
            .then(response => response.json())
            .then(data => renderCharts(data.article_labels, data.article_data, data.comment_labels, data.comment_data));
    }
});
</script>

<style>
img.rounded-circle { object-fit: cover; border: 3px solid #05035aff; }
.card { border-radius: 15px; }
.nav-pills .nav-link.active { background-color: #0d6efd; }
</style>

{% endblock %}
