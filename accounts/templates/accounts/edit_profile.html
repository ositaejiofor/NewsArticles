{% extends "core/base.html" %}

{% block title %}My Profile{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm p-4">

                <h3 class="text-center mb-4">My Profile</h3>

                <!-- ================== Tabs ================== -->
                <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">Profile Info</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab">Edit Profile</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">Activity</button>
                    </li>
                </ul>

                <!-- ================== Tab Contents ================== -->
                <div class="tab-content" id="profileTabsContent">

                    <!-- ===== Profile Info ===== -->
                    <div class="tab-pane fade show active" id="info" role="tabpanel">
                        <div class="text-center mb-4">
                            {% if request.user.profile_image %}
                                <img src="{{ request.user.profile_image.url }}" class="rounded-circle" alt="Profile Picture" width="120" height="120">
                            {% else %}
                                <img src="https://via.placeholder.com/120" class="rounded-circle" alt="Profile Picture">
                            {% endif %}
                        </div>
                        <h4 class="text-center">{{ request.user.username }}</h4>
                        <p class="text-center text-muted">{{ request.user.email }}</p>
                        <table class="table table-borderless mt-3">
                            <tr>
                                <th>Full Name:</th>
                                <td>{{ request.user.get_full_name|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Username:</th>
                                <td>{{ request.user.username }}</td>
                            </tr>
                            <tr>
                                <th>Email:</th>
                                <td>{{ request.user.email }}</td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td>
                                    {% if request.user.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inactive</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Joined:</th>
                                <td>{{ request.user.date_joined|date:"M d, Y" }}</td>
                            </tr>
                        </table>
                    </div>

                    <!-- ===== Edit Profile ===== -->
                    <div class="tab-pane fade" id="edit" role="tabpanel">
                        <form method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3 text-center">
                                {% if request.user.profile_image %}
                                    <img src="{{ request.user.profile_image.url }}" class="rounded-circle mb-2" alt="Profile Picture" width="120" height="120">
                                {% else %}
                                    <img src="https://via.placeholder.com/120" class="rounded-circle mb-2" alt="Profile Picture">
                                {% endif %}
                                <input type="file" name="profile_image" class="form-control mt-2">
                            </div>

                            <div class="mb-3">
                                <label for="full_name" class="form-label">Full Name</label>
                                <input type="text" id="full_name" name="full_name" class="form-control" value="{{ request.user.get_full_name }}">
                            </div>

                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" id="username" name="username" class="form-control" value="{{ request.user.username }}">
                            </div>

                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" id="email" name="email" class="form-control" value="{{ request.user.email }}">
                            </div>

                            <div class="mb-3">
                                <label for="password" class="form-label">New Password</label>
                                <input type="password" id="password" name="password" class="form-control" placeholder="Leave blank to keep current password">
                            </div>

                            <div class="d-grid mt-4">
                                <button type="submit" class="btn btn-warning btn-lg">Update Profile</button>
                            </div>
                        </form>
                    </div>

                    <!-- ===== Activity ===== -->
                    <div class="tab-pane fade" id="activity" role="tabpanel">
                        <ul class="list-group mb-3">
                            {% if recent_articles %}
                                {% for article in recent_articles %}
                                <li class="list-group-item">
                                    Published article: <strong>{{ article.title }}</strong> on {{ article.created_at|date:"M d, Y" }}
                                </li>
                                {% endfor %}
                            {% endif %}

                            {% if recent_comments %}
                                {% for comment in recent_comments %}
                                <li class="list-group-item">
                                    Commented on "<strong>{{ comment.article.title }}</strong>": {{ comment.body|truncatechars:50 }}
                                </li>
                                {% endfor %}
                            {% endif %}

                            {% if recent_logins %}
                                {% for login in recent_logins %}
                                <li class="list-group-item">
                                    Logged in at {{ login.timestamp|date:"M d, Y H:i" }} from IP {{ login.ip }}
                                </li>
                                {% endfor %}
                            {% endif %}
                        </ul>
                        {% if not recent_articles and not recent_comments and not recent_logins %}
                            <p class="text-center text-muted">No recent activity found.</p>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Optional CSS -->
<style>
img.rounded-circle {
    object-fit: cover;
    border: 3px solid #ffc107;
}
</style>

{% endblock %}
