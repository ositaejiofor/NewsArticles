{% extends "core/base.html" %}

{% block title %}Edit Profile{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm p-4">
                <h3 class="text-center mb-4">Edit Profile</h3>

                <!-- Display messages -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="POST" enctype="multipart/form-data" id="editProfileForm">
                    {% csrf_token %}

                    <!-- Profile Image -->
                    <div class="mb-3 text-center">
                        <img id="profilePreview"
                             src="{% if request.user.profile_image %}{{ request.user.profile_image.url }}{% else %}https://via.placeholder.com/120{% endif %}"
                             class="rounded-circle mb-2"
                             width="120" height="120"
                             style="object-fit: cover; border: 3px solid #ffc107; cursor: pointer;"
                             title="Click to select a new image">

                        {{ form.profile_image }}
                        <small class="form-text text-muted">Click the image to choose a new profile picture</small>
                    </div>

                    <!-- First Name -->
                    <div class="mb-3">
                        <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name</label>
                        {{ form.first_name }}
                        {% if form.first_name.errors %}
                            <div class="text-danger">{{ form.first_name.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Last Name -->
                    <div class="mb-3">
                        <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name</label>
                        {{ form.last_name }}
                        {% if form.last_name.errors %}
                            <div class="text-danger">{{ form.last_name.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Username -->
                    <div class="mb-3">
                        <label for="{{ form.username.id_for_label }}" class="form-label">Username</label>
                        {{ form.username }}
                        {% if form.username.errors %}
                            <div class="text-danger">{{ form.username.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Email -->
                    <div class="mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-danger">{{ form.email.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Password -->
                    <div class="mb-3">
                        <label for="{{ form.password.id_for_label }}" class="form-label">New Password</label>
                        <div class="input-group">
                            {{ form.password }}
                            <button type="button" class="btn btn-outline-secondary" id="togglePassword">Show</button>
                        </div>
                        {% if form.password.errors %}
                            <div class="text-danger">{{ form.password.errors }}</div>
                        {% endif %}
                        <small class="text-muted">Leave blank to keep current password</small>
                        <div id="passwordStrength" class="mt-1"></div>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-warning btn-lg">Update Profile</button>
                        <button type="button" class="btn btn-secondary btn-lg" id="cancelChanges">Cancel Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Custom JS -->
<script>
// Store original field values for cancel
const form = document.getElementById("editProfileForm");
const profileInput = document.getElementById("id_profile_image");
const profilePreview = document.getElementById("profilePreview");
const passwordInput = document.getElementById("id_password");

const originalValues = {
    first_name: document.getElementById("id_first_name").value,
    last_name: document.getElementById("id_last_name").value,
    username: document.getElementById("id_username").value,
    email: document.getElementById("id_email").value,
    profile_image: profilePreview.src,
    password: ""
};

// Profile image live preview
profilePreview.addEventListener("click", () => profileInput.click());
profileInput.addEventListener("change", function() {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = e => profilePreview.src = e.target.result;
        reader.readAsDataURL(file);
    } else {
        profilePreview.src = originalValues.profile_image;
    }
});

// Password show/hide
const togglePassword = document.getElementById("togglePassword");
const passwordStrength = document.getElementById("passwordStrength");
togglePassword.addEventListener("click", () => {
    const type = passwordInput.type === "password" ? "text" : "password";
    passwordInput.type = type;
    togglePassword.textContent = type === "password" ? "Show" : "Hide";
});

// Password strength indicator
passwordInput.addEventListener("input", () => {
    const val = passwordInput.value;
    let strength = "";
    let color = "";

    if (!val) {
        strength = "";
        color = "";
    } else if (val.length < 6) {
        strength = "Weak";
        color = "red";
    } else if (val.match(/^(?=.*[A-Za-z])(?=.*\d).{6,}$/)) {
        strength = "Medium";
        color = "orange";
    } else if (val.match(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/)) {
        strength = "Strong";
        color = "green";
    } else {
        strength = "Medium";
        color = "orange";
    }

    passwordStrength.textContent = strength ? `Strength: ${strength}` : "";
    passwordStrength.style.color = color;
});

// Cancel changes functionality (fully restores profile image)
document.getElementById("cancelChanges").addEventListener("click", () => {
    document.getElementById("id_first_name").value = originalValues.first_name;
    document.getElementById("id_last_name").value = originalValues.last_name;
    document.getElementById("id_username").value = originalValues.username;
    document.getElementById("id_email").value = originalValues.email;

    // Restore original profile image
    profilePreview.src = originalValues.profile_image;
    profileInput.value = ""; // clear file input

    passwordInput.value = ""; // clear password
    passwordStrength.textContent = "";
});
</script>

{% endblock %}
