{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-4">

<h2>Top Users by Articles</h2>

<!-- Dropdown -->
<div class="dropdown mb-3">
  <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
    Chart Settings
  </button>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="#" id="barOption">Bar Chart</a></li>
    <li><a class="dropdown-item" href="#" id="stackedOption">Stacked Bar</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="#" id="cumulativeOption">Cumulative</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="#" id="monthOption">Per Month</a></li>
    <li><a class="dropdown-item" href="#" id="yearOption">Per Year</a></li>
    <li><a class="dropdown-item" href="#" id="allOption">All Time</a></li>
    <li><a class="dropdown-item" href="#" id="customOption">Custom Range</a></li>
  </ul>
</div>

<!-- Chart -->
<canvas id="userChart" width="400" height="200"></canvas>

<!-- Saved prefs -->
<input type="hidden" id="savedStart" value="{{ prefs.custom_start|date:'Y-m-d' }}">
<input type="hidden" id="savedEnd" value="{{ prefs.custom_end|date:'Y-m-d' }}">
<input type="hidden" id="savedChartType" value="{{ prefs.chart_type }}">
<input type="hidden" id="savedCumulative" value="{{ prefs.cumulative|yesno:'true,false' }}">
<input type="hidden" id="savedTimeRange" value="{{ prefs.time_range }}">

<!-- Custom Range Modal -->
<div class="modal fade" id="customRangeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Custom Date Range</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">From:</label>
        <input type="date" class="form-control mb-3" id="customStart">
        <label class="form-label">To:</label>
        <input type="date" class="form-control" id="customEnd">
        <div id="dateError" class="text-danger mt-2" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="applyCustom" disabled>Apply</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const ctx = document.getElementById('userChart').getContext('2d');
  let chartData = JSON.parse('{{ chart_data|escapejs }}');
  let chart = new Chart(ctx, {
    type: 'bar',
    data: chartData,
    options: { responsive: true, scales: { x: { stacked: false }, y: { stacked: false, beginAtZero: true } } }
  });

  let defaultType = document.getElementById('savedChartType').value || 'bar';
  let cumulative = document.getElementById('savedCumulative').value === 'true';
  let time_range = document.getElementById('savedTimeRange').value || 'month';

  // Helpers
  function updatePreferences(payload) {
    fetch("{% url 'update_preferences' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
      chart.data = data.chart_data;
      chart.options.scales.x.stacked = data.prefs.chart_type === "stacked";
      chart.options.scales.y.stacked = data.prefs.chart_type === "stacked";
      chart.update();
      highlightMenu(data.prefs);
    });
  }

  function highlightMenu(prefs) {
    document.querySelectorAll('.dropdown-item').forEach(el => el.innerText = el.innerText.replace(" ✅",""));
    if (prefs.chart_type === "bar") document.getElementById('barOption').innerText += " ✅";
    if (prefs.chart_type === "stacked") document.getElementById('stackedOption').innerText += " ✅";
    if (prefs.cumulative) document.getElementById('cumulativeOption').innerText = "Cumulative ✅"; 
    else document.getElementById('cumulativeOption').innerText = "Cumulative";
    if (prefs.time_range === "month") document.getElementById('monthOption').innerText += " ✅";
    if (prefs.time_range === "year") document.getElementById('yearOption').innerText += " ✅";
    if (prefs.time_range === "all") document.getElementById('allOption').innerText += " ✅";
    if (prefs.time_range === "custom") document.getElementById('customOption').innerText += " ✅";
  }

  // Event bindings
  document.getElementById('barOption').addEventListener('click', () => updatePreferences({chart_type:"bar", cumulative, time_range}));
  document.getElementById('stackedOption').addEventListener('click', () => updatePreferences({chart_type:"stacked", cumulative, time_range}));
  document.getElementById('cumulativeOption').addEventListener('click', () => updatePreferences({chart_type:defaultType, cumulative:!cumulative, time_range}));

  document.getElementById('monthOption').addEventListener('click', () => updatePreferences({chart_type:defaultType, cumulative, time_range:"month"}));
  document.getElementById('yearOption').addEventListener('click', () => updatePreferences({chart_type:defaultType, cumulative, time_range:"year"}));
  document.getElementById('allOption').addEventListener('click', () => updatePreferences({chart_type:defaultType, cumulative, time_range:"all"}));

  // Modal logic
  const startInput = document.getElementById('customStart');
  const endInput = document.getElementById('customEnd');
  const applyBtn = document.getElementById('applyCustom');
  const errorBox = document.getElementById('dateError');

  function validateCustomRange() {
    const start = startInput.value;
    const end = endInput.value;
    if (!start || !end) { applyBtn.disabled = true; errorBox.style.display = "none"; return; }
    if (start > end) { applyBtn.disabled = true; errorBox.textContent = "End date must be after start date."; errorBox.style.display = "block"; return; }
    applyBtn.disabled = false; errorBox.style.display = "none";
  }

  startInput.addEventListener('input', () => { if (startInput.value) endInput.min = startInput.value; validateCustomRange(); });
  endInput.addEventListener('input', () => { if (endInput.value) startInput.max = endInput.value; validateCustomRange(); });

  document.getElementById('customOption').addEventListener('click', (e) => {
    e.preventDefault();
    const savedStart = document.getElementById('savedStart').value;
    const savedEnd = document.getElementById('savedEnd').value;
    startInput.value = savedStart || "";
    endInput.value = savedEnd || "";
    if (savedStart) endInput.min = savedStart;
    if (savedEnd) startInput.max = savedEnd;
    validateCustomRange();
    new bootstrap.Modal(document.getElementById('customRangeModal')).show();
  });

  applyBtn.addEventListener('click', () => {
    updatePreferences({chart_type:defaultType, cumulative, time_range:"custom", custom_start:startInput.value, custom_end:endInput.value});
    bootstrap.Modal.getInstance(document.getElementById('customRangeModal')).hide();
  });

  // Initial highlight
  highlightMenu({chart_type: defaultType, cumulative, time_range});
</script>
</body>
</html>
